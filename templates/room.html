<!DOCTYPE html>
<html>
<head>
    <title>Room {{ room_number }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.8.3.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            if ("WebSocket" in window)
            {
                var $answer_button = $('#answer_button');
                $answer_button.click(function()
                {
                    var data = {
                        type: '{{ ANSWER_QUERY_MESSAGE_TO_SERVER }}',
                        room: {{ room_number }},
                        user: '4qwee'
                    };
                    ws.send(JSON.stringify(data));
                });

                ws = new WebSocket("ws://" + document.domain + ":5000/roomWS");
                ws.onopen = function()
                {
                    var data = {
                        type: '{{ START_LISTENING_MESSAGE_TO_SERVER }}',
                        room: {{ room_number }}
                    };
                    ws.send(JSON.stringify(data));
                };
                ws.onmessage = function(event)
                {
                    var data = JSON.parse(event.data);
                    console.log(data);
                    console.log(new Date());

                    if (data.type == '{{ QUESTION_MESSAGE_TO_CLIENT }}')
                    {
                        var $progress_bar = $('#progress_bar');
                        var progress = 0;
                        $progress_bar.css('width', 0);
                        $answer_button.removeAttr('disabled');

                        $('#topic-span').text(data.topic);
                        $('#question-span').text(data.question);

                        var timerInterval = setInterval(function()
                        {
                            progress += 10;
                            $progress_bar.css('width', progress + '%');

                            if (progress == 100)
                            {
                                clearInterval(timerInterval);
                                $answer_button.attr('disabled', 'disabled');
                            }
                        }, 1000);
                    }
                    else if (data.type == '{{ STOP_ANSWER_MESSAGE_TO_CLIENT }}')
                    {
                        $answer_button.attr('disabled', 'disabled');
                    }
                };
            }
            else
            {
                alert("WebSocket not supported");
            }
        });
    </script>
</head>
<body>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span6 offset3 well" style="margin-top: 30pt">
            <div class="progress progress-striped active">
                <div class="bar" style="width: 0" id="progress_bar"></div>
            </div>

            <div class="lead">
                <strong id='topic-span'></strong>
                <p id="question-span">Обождите. Сейчас машина придумает вам вопрос
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span2 offset5">
            <button id="answer_button" class="btn btn-danger btn-block btn-large">Ответ</button>
        </div>
    </div>
</div>
</body>
</html>